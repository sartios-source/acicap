{% extends "base.html" %}

{% block title %}ACI Capacity Atlas{% endblock %}

{% block content %}
<section class="hero">
  <div class="hero-content">
    <h1>Enterprise ACI Scalability Atlas</h1>
    <p>Unified, multi-fabric capacity intelligence with Barclays-styled analytics and offline collection support.</p>
    <div class="hero-actions">
      <button class="primary" onclick="openFabricModal()">Create Fabric</button>
      <a class="ghost" href="{{ url_for('upload_page') }}">Upload Data</a>
    </div>
  </div>
  <div class="hero-orb">
    <div class="orb-ring"></div>
    <div class="orb-core"></div>
  </div>
</section>

<section class="panel metrics-grid">
    <div class="metric-card">
      <div class="metric-title">Total Leafs</div>
      <div class="metric-value" data-count="{{ totals.leafs }}">0</div>
      <div class="metric-sub">Spines: {{ totals.spines }}</div>
    </div>
    <div class="metric-card">
      <div class="metric-title">Total FEX Devices</div>
      <div class="metric-value" data-count="{{ totals.fex }}">0</div>
      <div class="metric-sub">Tenants: {{ totals.tenants }}</div>
    </div>
    <div class="metric-card">
      <div class="metric-title">Total EPGs</div>
      <div class="metric-value" data-count="{{ totals.epgs }}">0</div>
      <div class="metric-sub">BDs: {{ totals.bds }} · VRFs: {{ totals.vrfs }}</div>
    </div>
    <div class="metric-card">
      <div class="metric-title">Ports</div>
      <div class="metric-value" data-count="{{ totals.ports }}">0</div>
      <div class="metric-sub">Ports w/ EPG: {{ totals.ports_with_epg }}</div>
    </div>
  </section>

  <section class="panel fabric-gallery">
    <div class="panel-header">
      <h3>All Fabrics</h3>
      <div class="panel-actions">
        <input id="fabric-filter" placeholder="Filter fabrics..." oninput="filterFabrics()">
        <button class="ghost" onclick="expandAll(true)">Expand All</button>
        <button class="ghost" onclick="expandAll(false)">Collapse All</button>
      </div>
    </div>
    <div class="fabric-grid" id="fabric-grid">
      {% for item in fabric_views %}
      <div class="fabric-card" data-fabric="{{ item.fabric }}">
        <div class="fabric-card-header">
          <div>
            <div class="fabric-name">{{ item.fabric }}</div>
            <div class="fabric-meta">{{ item.meta.dataset_count }} datasets · {{ item.meta.modified }}</div>
          </div>
          <button class="ghost small" onclick="toggleFabric('{{ item.fabric }}')">Details</button>
        </div>
        <div class="fabric-card-metrics">
          <div>
            <div class="stat-value" data-count="{{ item.analysis.summary.leafs }}">0</div>
            <div class="stat-label">Leafs</div>
          </div>
          <div>
            <div class="stat-value" data-count="{{ item.analysis.summary.epgs }}">0</div>
            <div class="stat-label">EPGs</div>
          </div>
          <div>
            <div class="stat-value" data-count="{{ item.analysis.ports.ports_with_epg }}">0</div>
            <div class="stat-label">Ports w/ EPG</div>
          </div>
          <div>
            <div class="stat-value" data-count="{{ item.analysis.l3out.border_leaf_count }}">0</div>
            <div class="stat-label">Border Leafs</div>
          </div>
        </div>
        <div class="fabric-card-detail hidden" id="detail-{{ item.fabric }}">
          <div class="detail-grid">
            <div class="detail-block">
              <h4>Port Utilisation</h4>
              <div class="progress-bar">
                <div class="progress-fill" data-progress="{{ (item.analysis.ports.ports_with_epg / (item.analysis.ports.total or 1) * 100) | round(1) }}"></div>
              </div>
              <div class="progress-meta">
                {{ item.analysis.ports.ports_with_epg }} / {{ item.analysis.ports.total }} ports
              </div>
            </div>
            <div class="detail-block">
              <h4>Tenant Scale</h4>
              <div class="pill-row">
                <span class="pill">VRFs {{ item.analysis.summary.vrfs }}</span>
                <span class="pill">BDs {{ item.analysis.summary.bds }}</span>
                <span class="pill">EPGs {{ item.analysis.summary.epgs }}</span>
              </div>
            </div>
            <div class="detail-block">
              <h4>Completeness</h4>
              <div class="pill-row">
                <span class="pill {{ 'success' if not item.analysis.completeness.missing_required else 'danger' }}">
                  {{ item.analysis.completeness.completeness_score }}%
                </span>
              </div>
            </div>
            <div class="detail-block">
              <h4>Cisco Limits</h4>
              <div class="limit-meta">
                Release {{ item.analysis.cisco_limits.release }} · APIC {{ item.analysis.cisco_limits.cluster_size }}-node
              </div>
              <div class="limit-grid">
                <div>Leafs</div><div>{{ item.analysis.headroom.leafs.current }} / {{ item.analysis.headroom.leafs.maximum }}</div><div>{{ item.analysis.headroom.leafs.remaining }} left</div>
                <div>Spines</div><div>{{ item.analysis.headroom.spines.current }} / {{ item.analysis.headroom.spines.maximum }}</div><div>{{ item.analysis.headroom.spines.remaining }} left</div>
                <div>Leafs by Spine Ports</div><div>{{ item.analysis.headroom.leafs_by_spine_ports.current }} / {{ item.analysis.headroom.leafs_by_spine_ports.maximum }}</div><div>{{ item.analysis.headroom.leafs_by_spine_ports.remaining }} left</div>
                <div>Tenants</div><div>{{ item.analysis.headroom.tenants.current }} / {{ item.analysis.headroom.tenants.maximum }}</div><div>{{ item.analysis.headroom.tenants.remaining }} left</div>
                <div>VRFs</div><div>{{ item.analysis.headroom.vrfs.current }} / {{ item.analysis.headroom.vrfs.maximum }}</div><div>{{ item.analysis.headroom.vrfs.remaining }} left</div>
                <div>BDs</div><div>{{ item.analysis.headroom.bds.current }} / {{ item.analysis.headroom.bds.maximum }}</div><div>{{ item.analysis.headroom.bds.remaining }} left</div>
                <div>EPGs</div><div>{{ item.analysis.headroom.epgs.current }} / {{ item.analysis.headroom.epgs.maximum }}</div><div>{{ item.analysis.headroom.epgs.remaining }} left</div>
                <div>EPGs / Tenant</div><div>{{ item.analysis.headroom.epgs_per_tenant.current }} / {{ item.analysis.headroom.epgs_per_tenant.maximum }}</div><div>{{ item.analysis.headroom.epgs_per_tenant.remaining }} left</div>
                <div>Contracts</div><div>{{ item.analysis.headroom.contracts.current }} / {{ item.analysis.headroom.contracts.maximum }}</div><div>{{ item.analysis.headroom.contracts.remaining }} left</div>
                <div>FEX</div><div>{{ item.analysis.headroom.fex.current }} / {{ item.analysis.headroom.fex.maximum }}</div><div>{{ item.analysis.headroom.fex.remaining }} left</div>
                <div>Ports</div><div>{{ item.analysis.headroom.ports.current }} / {{ item.analysis.headroom.ports.maximum }}</div><div>{{ item.analysis.headroom.ports.remaining }} left</div>
              </div>
              <div class="limit-meta" style="margin-top:8px;">
                Uplinks per leaf (assumed): {{ item.analysis.spine_capacity.uplinks_per_leaf }} ·
                Spine ports: {{ item.analysis.spine_capacity.total_spine_ports }} ·
                Remaining leafs before linecards: {{ item.analysis.spine_capacity.remaining_leafs_before_linecards }}
              </div>
            </div>
            <div class="detail-block">
              <h4>Actions</h4>
              <div class="panel-actions">
                <button class="ghost small" onclick="selectFabric('{{ item.fabric }}')">Focus</button>
                <a class="primary small" href="{{ url_for('export_excel', fabric_name=item.fabric) }}">Export Excel</a>
                <button class="danger small" onclick="deleteFabric('{{ item.fabric }}')">Delete</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% else %}
        <div class="empty">No fabrics yet. Create one to get started.</div>
      {% endfor %}
    </div>
  </section>

  <section class="panel split">
    <div class="chart-card">
      <h3>Global Port Utilisation</h3>
      <div class="ring">
        <svg viewBox="0 0 120 120">
          <circle cx="60" cy="60" r="50"></circle>
          <circle cx="60" cy="60" r="50" class="ring-progress"
                  data-progress="{{ (totals.ports_with_epg / (totals.ports or 1) * 100) | round(1) }}"></circle>
        </svg>
        <div class="ring-center">
          <div class="ring-value">{{ totals.ports_with_epg }}</div>
          <div class="ring-label">ports with EPG</div>
        </div>
      </div>
      <div class="ring-meta">
        <span>Total Ports: {{ totals.ports }}</span>
      </div>
    </div>

    <div class="chart-card">
      <h3>Fabric Discovery</h3>
      <div class="stat-grid">
        <div>
          <div class="stat-value" data-count="{{ fabrics | length }}">0</div>
          <div class="stat-label">Fabrics</div>
        </div>
        <div>
          <div class="stat-value" data-count="{{ totals.tenants }}">0</div>
          <div class="stat-label">Tenants</div>
        </div>
        <div>
          <div class="stat-value" data-count="{{ totals.vrfs }}">0</div>
          <div class="stat-label">VRFs</div>
        </div>
        <div>
          <div class="stat-value" data-count="{{ totals.bds }}">0</div>
          <div class="stat-label">BDs</div>
        </div>
      </div>
      <div class="pill-row">
        <span class="pill">EPGs {{ totals.epgs }}</span>
        <span class="pill">Subnets {{ totals.subnets }}</span>
        <span class="pill">Contracts {{ totals.contracts }}</span>
      </div>
    </div>
  </section>


<div id="fabric-modal" class="modal hidden">
  <div class="modal-card">
    <h3>Create Fabric</h3>
    <input id="fabric-name" placeholder="fabric-name">
    <input id="fabric-desc" placeholder="description (optional)">
    <div class="modal-actions">
      <button class="ghost" onclick="closeFabricModal()">Cancel</button>
      <button class="primary" onclick="createFabric()">Create</button>
    </div>
  </div>
</div>
{% endblock %}
